@inject IJSRuntime JSRuntime
@inject IFieldService fieldService
@inject IUserService userService
@page "/map"
@using HttpClients.ClientInterfaces
@using Domain.DTOs
<AuthorizeView>
<h3>MapView</h3>

<div id="mapid" style="height: 400px;"></div>

    <button @onclick="ToggleMarkerPlacement">Toggle Marker Placement</button>
    <button @onclick="DrawAllPolygons">Draw Area</button>
    <button @onclick="EnableDrawingMode">Register a New Field</button>
    <button @onclick="AddNewField">Create Field</button>
</AuthorizeView>
@code {
    private IEnumerable<FieldLookupDto>? fields;
    private int currentUserId;
    private string msg = "";
    private ElementReference mapElement;
    private string geoLocationData = null;

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await userService.GetCurrentUserId();

        try
        {
            fields = await fieldService.GetFieldsByUserId(currentUserId);
          
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            msg = e.Message;
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initializeMap");
            await DrawAllPolygons();
        }
    }


    private async Task DrawAllPolygons()
    {
        if (fields != null)
        {
            foreach (var field in fields)
            {
                if (!string.IsNullOrWhiteSpace(field.locationData))
                {
                    await JSRuntime.InvokeVoidAsync("drawPolygonFromCoordinateString", field.locationData);
                }
            }
            await JSRuntime.InvokeVoidAsync("zoomToFitAllFields");
        }
    }

    private async Task EnableDrawingMode()
    {
        Console.WriteLine("trying to enable this");
        await JSRuntime.InvokeVoidAsync("toggleDrawingMode");
    }
    private async Task ToggleMarkerPlacement()
    {
        await JSRuntime.InvokeVoidAsync("toggleMarkerPlacement");
    }


    // Mock API call function - replace with your actual API call logic

    private async Task AddNewField()
    {
        await JSRuntime.InvokeVoidAsync("createField");
    }

    [JSInvokable]
    public static Task ReceiveDataFromJs(string locationData)
    {
        Console.WriteLine($"Received location data: {locationData}");
    // Yderligere logik til at håndtere locationData
        return Task.CompletedTask;
    }

}

